---
title: "The Report of the Correlation between Healthcare Preparedness and COVID-19 Mortality"
author: "Jun, Irene, Binh, Weidun"
date: "12/15/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) 
```

```{r load-libraries}
library(tidyverse)
library(ggplot2)
library(magrittr)
library(dplyr)
library(readr)
library(countrycode)
library(ggthemes)
```

```{r load-csv-file}
data <- read.csv("https://wzb-ipi.github.io/corona/df_full.csv") %>%
          filter(elapsed == 334)
```

```{r process-data}
data <- data %>%
  select(country, continent, population_2019, pop_density, deaths_cum, deaths_cum_per_million, health_exp_pc, hosp_beds_pc, health_index, share_older)  
```

```{r convert-country-code}
survey <- read.csv('survey_healthcare.csv') %>%
            select(!(gender:age)) %>%
            mutate(country = countrycode(country, 'iso2c', 'country.name'))
```

```{r merge-data}
survey_merge <- right_join(data, survey)
```

```{r fliter-outliers}
data_wo_outliers <- data %>%
  filter(deaths_cum < 100000)

```

Health Expenses: 

```{r plot-health-expenses}
ggplot(data, aes(y=deaths_cum_per_million, x=health_exp_pc)) +
    theme_tufte() +
    stat_smooth(method='lm') +
    geom_point() +
    labs(title = "Health Expenses vs. COVID-19-associated deaths per million",
         subtitle = "All Countries", y = "Deaths per million", x = "Health Expenses per capita")

 # Get correlation
cor(data$health_exp_pc, data$deaths_cum_per_million, use = "complete.obs")
 
 # Linear Regression
lm_health_exp <- lm(deaths_cum_per_million ~ health_exp_pc, data)
summary(lm_health_exp)

# t.test(data_share_older$health_exp_pc)
```

This rather looking very unexpected, so we looked at one of the confounding variable: population of older population.


```{r plot-health-expenses-and-share-older}

data_share_older <- data %>% filter(!is.na(share_older))

ggplot(data, aes(y=deaths_cum_per_million, x=health_exp_pc, color = share_older)) +
    theme_tufte() +
    stat_smooth(method='lm') +
    geom_point()+
    labs(title = "Health Expenses vs. COVID-19-associated deaths per million",
         subtitle = "All Countries", y = "Deaths per million", x = "Health Expenses")


```

Note that the darker-blue dots tend to stay on the left side of the graph (less health expenses), while the 
lighter-blue dots tend to stay on the right side (more health expenses).

```{r compare-older-share-and-expenses}

ggplot(data_share_older, aes(y=health_exp_pc, x=share_older)) +
    theme_tufte() +
    stat_smooth(method='lm') +
    geom_point()+
    labs(title = "The relationship between population share of older people and healthcare expenses",
         subtitle = "All Countries", y = "Healthcare expenses", x = "Share of older population")

 # Get the correlation coefficient
cor(data_share_older$share_older, data_share_older$health_exp_pc, use='complete.obs')

 # Linear Regression
share_and_expense = lm(health_exp_pc~share_older, data_share_older)
summary(share_and_expense)
```
So, it's possible that it's not the healthcare expenses alone that might affect the mortalities but the share of older population affecting both of the healthcare expenses and the mortalities.

Number of hospital beds simply means the capacities of hospitals to admit patients. We looked into the correlation between the number of hospital beds (per capita) and the mortalities.

```{r plot-hosptal-beds}
data_hosp_beds_pc <- data %>% filter(!is.na(hosp_beds_pc))

ggplot(data_hosp_beds_pc, mapping = aes(x = hosp_beds_pc, y = deaths_cum_per_million)) +
  geom_point() +
  theme_tufte() +
  labs(title = "COVID-19 mortality rate and number of hospital beds available", 
       subtitle = "All countries", 
       x = "Number of hospital beds", y = "Deaths per Million") +
  stat_smooth(method='lm')

  
#ggplot(data_hosp_beds_pc, mapping = aes(x = hosp_beds_pc, y = deaths_cum_per_million, color = continent)) +
#  geom_point() +
#  theme_tufte() +
#  labs(title = "COVID-19 mortality rate and number of hospital beds available", 
#       subtitle = "All countries", 
#       x = "Number of hospital beds", y = "Deaths per Million")

 # Get correlation coefficient
cor(data_hosp_beds_pc$hosp_beds_pc, data_hosp_beds_pc$deaths_cum_per_million, use = "complete.obs")

 # Get confidence interval
hosp_beds_and_mortality = lm(deaths_cum_per_million~hosp_beds_pc, data_hosp_beds_pc)
summary(hosp_beds_and_mortality)
```
It merely shows a weak correlation with r-squared number around 0.04. 

```{r plot-health-index}
data_health_index <- data %>% filter(!is.na(health_index))

ggplot(data_health_index, mapping = aes(x = health_index, y = deaths_cum_per_million)) +
  geom_point() +
  labs(title = "COVID-19 mortality rate and health index", subtitle = "All countries", 
       x = "Health index", y = "Deaths per million") +
  stat_smooth(method='lm') +
  theme_tufte()

# Get the correlation coefficient
cor(data_health_index$health_index, data_health_index$deaths_cum_per_million, use = "complete.obs")

 # Get confidence interval
health_index_and_mortality = lm(deaths_cum_per_million~health_index, data_health_index)
summary(health_index_and_mortality) 
```


