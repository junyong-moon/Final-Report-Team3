---
title: "The Report of the Correlation between Healthcare Preparedness and COVID-19 Mortality"
author: "Jun, Irene, Binh, Weidun"
date: "12/15/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) 
```

```{r load-libraries}
library(tidyverse)
library(ggplot2)
library(magrittr)
library(dplyr)
library(readr)
library(countrycode)
library(ggthemes)
```

```{r load-csv-file}
data <- read.csv("https://wzb-ipi.github.io/corona/df_full.csv") %>%
          filter(elapsed == 334)

```

```{r process-data}
data <- data %>%
  select(country, continent, population_2019, pop_density, deaths_cum, deaths_cum_per_million, health_exp_pc, hosp_beds_pc, share_older)  
```

```{r convert-country-code}
survey <- read.csv('survey_healthcare.csv') %>%
            select(!(gender:age)) %>%
            mutate(country = countrycode(country, 'iso2c', 'country.name'))
```

```{r merge-data}
ghsi <- read.csv('ghsi.csv')
data <- left_join(data, ghsi)

survey_merge <- right_join(data, survey)

data
```

```{r fliter-outliers}
data_wo_outliers <- data %>%
  filter(deaths_cum < 100000)

```

Health Expenses: 

```{r plot-health-expenses}
ggplot(data, aes(y=deaths_cum_per_million, x=health_exp_pc)) +
    theme_tufte() +
    stat_smooth(method='lm') +
    geom_point() +
    labs(title = "Health Expenses vs. COVID-19-associated deaths per million",
         subtitle = "All Countries", y = "Deaths per million", x = "Health Expenses per capita (USD)") 


```
This rather looking very unexpected, indincating more deaths for more health expenses per capita. Here are the details for the dataset.

```{r health-expenses}
 # Get correlation
cor(data$health_exp_pc, data$deaths_cum_per_million, use = "complete.obs")
 

 # Linear Regression
lm_health_exp <- lm(deaths_cum_per_million ~ health_exp_pc, data)
summary(lm_health_exp)

t.test(data$health_exp_pc, data$deaths_cum_per_million)
```

To address this unexpected pattern, we looked at one of the confounding variable: share of older population.

```{r plot-health-expenses-and-share-older}

data_share_older <- data %>% filter(!is.na(share_older))

ggplot(data, aes(y=deaths_cum_per_million, x=health_exp_pc, color = share_older)) +
    theme_tufte() +
    stat_smooth(method='lm') +
    geom_point()+
    labs(title = "Health Expenses vs. COVID-19-associated deaths per million",
         subtitle = "All Countries", y = "Deaths per million", x = "Health Expenses")


```

Note that the darker-blue dots tend to stay on the left side of the graph (less health expenses), while the 
lighter-blue dots tend to stay on the right side (more health expenses). The following plot shows the correlation between the elder population share and health expenses per capita.

```{r compare-older-share-and-expenses}

ggplot(data_share_older, aes(y=health_exp_pc, x=share_older)) +
    theme_tufte() +
    stat_smooth(method='lm') +
    geom_point()+
    labs(title = "The relationship between population share of older people and healthcare expenses",
         subtitle = "All Countries", y = "Healthcare expenses (dollars)", x = "Share of older population (%)")

 # Get the correlation coefficient
cor(data_share_older$share_older, data_share_older$health_exp_pc, use='complete.obs')

 # Linear Regression
share_and_expense = lm(health_exp_pc~share_older, data_share_older)
summary(share_and_expense)
```
It gives a clear relationship between the population share and the expenditure, following the intuition that older people tend to spend more for healthcare. So, it's possible that it's not the healthcare expenses alone that might affect the mortalities but the share of older population affecting both of the healthcare expenses and the mortalities. 

We picked two groups of countries, the first having very low share of older population and another having fairly high.
```{r get-median-older-pop}
summary(data_share_older$share_older)
```
```{r plot-lower-older-pop}
data_control_shareolder_1 <- data_share_older %>% 
                            select(deaths_cum_per_million, share_older, health_exp_pc) %>%
                            filter(share_older < 3)
  
ggplot(data_control_shareolder_1, aes(y=deaths_cum_per_million, x=health_exp_pc, color = share_older)) +
    theme_tufte() +
    stat_smooth(method='lm') +
    geom_point() +
    labs(title = "The relationship between healthcare expenses and mortality rate",
         subtitle = "For those countries having low share_older (less than 3 percent)",
         y = "Deaths per million", x = "Healthcare expenditure (dollars)")

lm_control_shareolder_1 <- lm(deaths_cum_per_million ~ health_exp_pc, data = data_control_shareolder_1)
summary(lm_control_shareolder_1)
```
Due to the cluster at the lowest healthcare expenditure, The corrlation becomes highly significant, although the pattern did not result yet again not as expected.

Despite the more clear pattern for the countries with the lower-share, the pattern becomes very unsignificant the countries with the higher-share.

```{r plot-higher-older-pop}
data_control_shareolder_2 <- data_share_older %>% 
                            select(deaths_cum_per_million, share_older, health_exp_pc) %>%
                            filter(share_older > 10)
  
ggplot(data_control_shareolder_2, aes(y=deaths_cum_per_million, x=health_exp_pc, color = share_older)) +
    theme_tufte() +
    stat_smooth(method='lm') +
    geom_point() +
    labs(title = "The relationship between healthcare expenses and mortality rate",
         subtitle = "For those countries having low share_older (less than 3 percent)",
         y = "Deaths per million", x = "Healthcare expenditure (dollars)")

lm_control_shareolder_2 <- lm(deaths_cum_per_million ~ health_exp_pc, data = data_control_shareolder_2)
summary(lm_control_shareolder_2)
```
Thus, in spite of the control, Healthcare expenditure and deaths per million have positive correlation.


Number of hospital beds simply means the capacities of hospitals to admit patients. We looked into the correlation between the number of hospital beds (per capita) and the mortalities.

```{r plot-hosptal-beds}
data_hosp_beds_pc <- data %>% filter(!is.na(hosp_beds_pc))

ggplot(data_hosp_beds_pc, mapping = aes(x = hosp_beds_pc, y = deaths_cum_per_million)) +
  geom_point() +
  theme_tufte() +
  labs(title = "COVID-19 mortality rate and number of hospital beds available", 
       subtitle = "All countries", 
       x = "Number of hospital beds", y = "Deaths per Million") +
  stat_smooth(method='lm')

 # Get correlation coefficient
cor(data_hosp_beds_pc$hosp_beds_pc, data_hosp_beds_pc$deaths_cum_per_million, use = "complete.obs")

 # Get confidence interval
hosp_beds_and_mortality = lm(deaths_cum_per_million~hosp_beds_pc, data_hosp_beds_pc)
summary(hosp_beds_and_mortality)
```
It merely shows a weak correlation with r-squared number around 0.04.

However, when we introduce regions, the 
```{r plot-hospital-bed-with-regions}
ggplot(data_hosp_beds_pc, mapping = aes(x = hosp_beds_pc, y = deaths_cum_per_million, color = continent)) +
  geom_point() +
  theme_tufte() +
  labs(title = "COVID-19 mortality rate and number of hospital beds available", 
       subtitle = "All countries", 
       x = "Number of hospital beds", y = "Deaths per Million") +
  stat_smooth(method='lm')
```
Each region shows different patterns, with some having as expected.

We dived groups by continents, and performed linear regression on each group.

```{r divide-groups-by-region}
data_control_region <- data_hosp_beds_pc %>%
                        select(hosp_beds_pc, continent, deaths_cum_per_million)

data_control_region_america <- data_control_region %>% filter(continent == 'America')

data_control_region_asia <- data_control_region %>% filter(continent == 'Asia')

data_control_region_europe <- data_control_region %>% filter(continent == 'Europe')

data_control_region_africa <- data_control_region %>% filter(continent == 'Africa')

data_control_region_oceania <- data_control_region %>% filter(continent == 'Oceania')
```

```{r plot-america}
ggplot(data_control_region_america, mapping = aes(x = hosp_beds_pc, y = deaths_cum_per_million)) +
  geom_point() +
  theme_tufte() +
  labs(title = "COVID-19 mortality rate and number of hospital beds available", 
       subtitle = "All countries", 
       x = "Number of hospital beds", y = "Deaths per Million") +
  stat_smooth(method='lm')

 # Get confidence interval
lm_hosp_bed_am = lm(deaths_cum_per_million~hosp_beds_pc, data_control_region_america)
summary(lm_hosp_bed_am)
```

```{r plot-europe}
ggplot(data_control_region_europe, mapping = aes(x = hosp_beds_pc, y = deaths_cum_per_million)) +
  geom_point() +
  theme_tufte() +
  labs(title = "COVID-19 mortality rate and number of hospital beds available", 
       subtitle = "All countries", 
       x = "Number of hospital beds", y = "Deaths per Million") +
  stat_smooth(method='lm')

 # Get confidence interval
lm_hosp_bed_eu = lm(deaths_cum_per_million~hosp_beds_pc, data_control_region_europe)
summary(lm_hosp_bed_eu)
```
```{r plot-asia}
ggplot(data_control_region_asia, mapping = aes(x = hosp_beds_pc, y = deaths_cum_per_million)) +
  geom_point() +
  theme_tufte() +
  labs(title = "COVID-19 mortality rate and number of hospital beds available", 
       subtitle = "All countries", 
       x = "Number of hospital beds", y = "Deaths per Million") +
  stat_smooth(method='lm')

 # Get confidence interval
lm_hosp_bed_as = lm(deaths_cum_per_million~hosp_beds_pc, data_control_region_asia)
summary(lm_hosp_bed_as)
```
```{r plot-oceania}
ggplot(data_control_region_oceania, mapping = aes(x = hosp_beds_pc, y = deaths_cum_per_million)) +
  geom_point() +
  theme_tufte() +
  labs(title = "COVID-19 mortality rate and number of hospital beds available", 
       subtitle = "All countries", 
       x = "Number of hospital beds", y = "Deaths per Million") +
  stat_smooth(method='lm')

 # Get confidence interval
lm_hosp_bed_oc = lm(deaths_cum_per_million~hosp_beds_pc, data_control_region_oceania)
summary(lm_hosp_bed_oc)
```

```{r plot-africa}
ggplot(data_control_region_africa, mapping = aes(x = hosp_beds_pc, y = deaths_cum_per_million)) +
  geom_point() +
  theme_tufte() +
  labs(title = "COVID-19 mortality rate and number of hospital beds available", 
       subtitle = "All countries", 
       x = "Number of hospital beds", y = "Deaths per Million") +
  stat_smooth(method='lm')

 # Get confidence interval
lm_hosp_bed_af = lm(deaths_cum_per_million~hosp_beds_pc, data_control_region_africa)
summary(lm_hosp_bed_af)
```

```{r plot-ghsi}
data_ghsi <- data %>% filter(!is.na(ghsi))

ggplot(data_health_index, mapping = aes(x = ghsi, y = deaths_cum_per_million)) +
  geom_point() +
  labs(title = "COVID-19 mortality rate and health index", subtitle = "All countries", 
       x = "Health index", y = "Deaths per million") +
  stat_smooth(method='lm') +
  theme_tufte()

# Get the correlation coefficient
# cor(data_health_index$health_index, data_health_index$deaths_cum_per_million, use = "complete.obs")

 # Get confidence interval
ghsi_and_mortality = lm(deaths_cum_per_million~ghsi, data_ghsi)
summary(ghsi_and_mortality) 
```


